#!/bin/bash

# Prescription Clarity - Quick Fix Script
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏—Ö –ø—Ä–æ–±–ª–µ–º

echo ""
echo "üîß Prescription Clarity - Quick Fix"
echo "===================================="
echo ""

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≤–æ–¥—É —É—Å–ø—ñ—à–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
success() {
    echo -e "${GREEN}‚úì${NC} $1"
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≤–æ–¥—É –ø–æ–º–∏–ª–æ–∫
error() {
    echo -e "${RED}‚úó${NC} $1"
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≤–æ–¥—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
info() {
    echo -e "${BLUE}‚Ñπ${NC} $1"
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≤–æ–¥—É –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å
warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Node.js
echo "üìã –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–∏..."
echo ""

if ! command -v node &> /dev/null; then
    error "Node.js –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    echo ""
    echo "–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å Node.js v18+ –∑ https://nodejs.org/"
    exit 1
fi

NODE_VERSION=$(node --version)
success "Node.js –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: $NODE_VERSION"

if ! command -v npm &> /dev/null; then
    error "npm –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    exit 1
fi

NPM_VERSION=$(npm --version)
success "npm –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: $NPM_VERSION"

echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ package.json
if [ ! -f "package.json" ]; then
    error "package.json –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
    echo ""
    echo "–í–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó?"
    pwd
    exit 1
fi

success "package.json –∑–Ω–∞–π–¥–µ–Ω–æ"
echo ""

# –ú–µ–Ω—é –≤–∏–±–æ—Ä—É
echo "–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:"
echo ""
echo "1. üöÄ –®–≤–∏–¥–∫–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)"
echo "2. üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à Vite"
echo "3. üîÑ –ü–æ–≤–Ω–∞ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π"
echo "4. üì¶ –¢—ñ–ª—å–∫–∏ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –±–∞–∑—É –¥–∞–Ω–∏—Ö"
echo "5. üß™ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∑ —Ç–µ—Å—Ç–æ–º"
echo "6. üÜò –ï–∫—Å—Ç—Ä–µ–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (Git reset)"
echo ""
read -p "–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä (1-6): " choice

case $choice in
    1)
        echo ""
        info "–®–≤–∏–¥–∫–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è..."
        echo ""
        
        # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
        info "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
        npm install
        if [ $? -eq 0 ]; then
            success "–ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
        else
            error "–ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π"
            exit 1
        fi
        
        # –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ë–î
        info "–ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
        npm run prepare-db
        if [ $? -eq 0 ]; then
            success "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–∞"
        else
            warning "–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ë–î (–º–æ–∂–ª–∏–≤–æ, –≤–æ–Ω–∞ –≤–∂–µ —î)"
        fi
        
        # –û—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É
        info "–û—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É Vite..."
        rm -rf node_modules/.vite
        success "–ö–µ—à –æ—á–∏—â–µ–Ω–æ"
        
        echo ""
        success "–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
        echo ""
        info "–ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä..."
        npm run dev
        ;;
        
    2)
        echo ""
        info "–û—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É Vite..."
        rm -rf node_modules/.vite
        success "–ö–µ—à –æ—á–∏—â–µ–Ω–æ"
        
        info "–ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
        npm run prepare-db
        
        echo ""
        success "–ì–æ—Ç–æ–≤–æ!"
        echo ""
        info "–ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä..."
        npm run dev
        ;;
        
    3)
        echo ""
        warning "–£–í–ê–ì–ê: –í–∏–¥–∞–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
        read -p "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏? (y/n): " confirm
        
        if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
            info "–í–∏–¥–∞–ª–µ–Ω–Ω—è node_modules..."
            rm -rf node_modules
            success "node_modules –≤–∏–¥–∞–ª–µ–Ω–æ"
            
            info "–í–∏–¥–∞–ª–µ–Ω–Ω—è package-lock.json..."
            rm -f package-lock.json
            success "package-lock.json –≤–∏–¥–∞–ª–µ–Ω–æ"
            
            info "–ß–∏—Å—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è..."
            npm install
            if [ $? -eq 0 ]; then
                success "–ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
            else
                error "–ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è"
                exit 1
            fi
            
            info "–ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
            npm run copy-db
            
            echo ""
            success "–ü–æ–≤–Ω–∞ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
            echo ""
            info "–ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä..."
            npm run dev
        else
            info "–°–∫–∞—Å–æ–≤–∞–Ω–æ"
        fi
        ;;
        
    4)
        echo ""
        info "–ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
        npm run copy-db
        
        echo ""
        success "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–∞!"
        echo ""
        info "–ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä..."
        npm run dev
        ;;
        
    5)
        echo ""
        info "–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –∑–∞–ø—É—Å–∫—É –∑ —Ç–µ—Å—Ç–æ–º..."
        
        npm install
        npm run copy-db
        rm -rf node_modules/.vite
        
        echo ""
        success "–ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä..."
        echo ""
        info "–ü—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É:"
        echo "  1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å F12"
        echo "  2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å 'Debug'"
        echo "  3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å 'üß™ Test Database'"
        echo ""
        
        npm run dev
        ;;
        
    6)
        echo ""
        warning "üö® –£–í–ê–ì–ê: –ï–∫—Å—Ç—Ä–µ–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è"
        echo ""
        echo "–¶–µ –≤–∏–¥–∞–ª–∏—Ç—å:"
        echo "  ‚Ä¢ –í—Å—ñ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏ –≤ –∫–æ–¥—ñ"
        echo "  ‚Ä¢ –í—Å—ñ –Ω–æ–≤—ñ —Ñ–∞–π–ª–∏"
        echo "  ‚Ä¢ –í–µ—Å—å –∫–µ—à —Ç–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ"
        echo ""
        read -p "–í–ò –í–ü–ï–í–ù–ï–ù–Ü? –¶–µ –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–æ! (yes/no): " confirm
        
        if [ "$confirm" = "yes" ]; then
            info "Git reset..."
            git reset --hard HEAD
            
            info "Git clean..."
            git clean -fd
            
            info "–í–∏–¥–∞–ª–µ–Ω–Ω—è node_modules..."
            rm -rf node_modules
            
            info "–í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–µ—à—É..."
            rm -rf node_modules/.vite
            
            info "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
            npm install
            
            info "–ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
            npm run copy-db
            
            echo ""
            success "–ï–∫—Å—Ç—Ä–µ–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
            echo ""
            warning "–í—Å—ñ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏ –≤—Ç—Ä–∞—á–µ–Ω–æ!"
            echo ""
            info "–ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä..."
            npm run dev
        else
            info "–°–∫–∞—Å–æ–≤–∞–Ω–æ (—Å–ª–∞–≤–∞ –ë–æ–≥—É!)"
        fi
        ;;
        
    *)
        error "–ù–µ–≤—ñ—Ä–Ω–∏–π –≤–∏–±—ñ—Ä"
        exit 1
        ;;
esac
